---
- name: Install nginx and ufw
  ansible.builtin.apt:
    name:
      - nginx
      - ufw

- name: Enable nginx
  ansible.builtin.service:
    name: nginx
    enabled: true
    state: started

- name: Enable ufw
  ansible.builtin.ufw:
    state: enabled

- name: Allow HTTP
  ansible.builtin.ufw:
    rule: allow
    name: Nginx HTTP

- name: Allow HTTPS
  ansible.builtin.ufw:
    rule: allow
    name: Nginx HTTPS

- name:  Set hash bucket size
  ansible.builtin.lineinfile:
    path: "/etc/nginx/nginx.conf"
    regex: "(# )?server_names_hash_bucket_size 64;"
    line: "        server_names_hash_bucket_size 128;"
    state: present
  notify:
    - Reload nginx

- name: Setup sites
  include_tasks: site.yml
  vars:
    site: "{{ item }}"
  loop: "{{ sites }}"
  when: sites is defined

- name: Flush Handlers
  ansible.builtin.meta: flush_handlers